---
output: beamer_presentation
header-includes: \usepackage{graphicx}
---


```{r setup, include = F}

rm(list=ls())

#Load knitr 
library(knitr)

#Set some options
options(na.action='na.fail')
opts_knit$set(root.dir = '..')
opts_chunk$set(echo=FALSE,
               warning=FALSE,
               message=FALSE,
               fig.width=5,
               fig.height=3,
               fig.path = "../Figures/")

```

```{r load and clean, include = F}

#Load and clean data
source('Scripts/GWAS_sims_LOAD.R')
source('Scripts/GWAS_sims_FUNCTIONS.R')
source('Scripts/GWAS_sims_CLEAN.R')

```



## Genome-wide association studies in natural populations: managing expectations and avoiding error

Susan E. Johnston & Lewis G. Spurgin

\vspace{0.3cm}

\begin{center}
\includegraphics[width=0.8\textwidth]{Images/manhattan.png}
\end{center}

\vspace{0.3cm}

\begin{center}
\includegraphics[width=0.9\textwidth]{Images/logos.png}
\end{center}






----

\begin{center}
\includegraphics[width=1\textwidth]{Images/traits.png}
\end{center}




##Linking genotype and phenotype in the wild

- How heritable is my trait?
- How many loci are associated with my trait?
- What are their relative effect sizes?
- What evolutionary processes are driving their variation?



##**G**enome **W**ide **A**ssociation **S**tudy (GWAS)

Experimental design used to detect associations between genetic variants and traits in population samples



----

\begin{center}
\includegraphics[width=1\textwidth]{Images/gwas_success.png}
\end{center}

\begin{flushright}
\tiny{Visscher et al. 2017, AJHG}
\end{flushright}




----

\begin{center}
\includegraphics[width=1\textwidth]{Images/wild_gwas.png}
\end{center}

\begin{flushright}
\tiny{Slate et al. 2010, Trends Gen.}
\end{flushright}



##Linking genotype and phenotype in the wild

- How heritable is my trait?
- How many loci are associated with my trait?
- What are their relative effect sizes?
- What evolutionary processes are driving their variation?

**How many (and which) individuals do I need to sample? How many loci?**






##Study aims

Develop a simulation and analysis pipeline to:

- Illustrate some of the key issues affecting the power and promise of GWAS in natural populations
- Allow other researchers to estimate power in their system before undertaking costly fieldwork/genotyping






##Key factors to consider in GWAS

**How many (and which) individuals do I need to sample? How many loci?**

Two (of several) key factors to consider:

- Architecture of the trait
- Extent of linkage disequilibrium (LD) in the study population






##Linkage disequilibrium (LD) and GWAS

\begin{center}
\includegraphics[width=1\textwidth]{Images/ld_birds.png}
\end{center}

\vspace{0.3cm}

\begin{flushright}
\tiny{Bosse et al. 2017, Science; Knief et al. 2017, Mol. Ecol.}
\end{flushright}





##Study predictions

In simulated populations with different evolutionary histories and family structures:

- 












##Simulation approach

- We simulated quantitative traits under three **scenarios**, representing diverse natural systems with different population histories
- We **did not** perform exhaustive simulations to establish whih parameters most affect GWAS

\begin{center}
\includegraphics[width=0.8\textwidth]{Images/scenarios.png}
\end{center}





##Simulation approach

Used the software **QMSim** (Sargolzaei and Schenkel 2009, Bioinformatics), to:

1. Simulate historical population to establish **ancestral LD**
2. Simulate recent pedigrees to generate **sample LD**



##Simulation approach

Sample size:

- Five sample sizes tested (250,500,1000,2500,5000)
- Five marker panel sizes tested (5k,20k,50k,100k,200k)
- 100 replicates per simulation



##Simulation approach

Trait architecture:

- 10 QTL on 10 chromosomes (1 QTL per chromosome)
- Gamma distribution of QTL effect sizes
- Heritability of 0.4
- No selection
- Kept constant in all simulations



##Downstream analyses

Used GCTA to:

- Identify significant GWAS hits
- Estimate QTL effect sizes
- Estimate trait heritability (should be 0.4 in all simulations)





##Scenario 1

- Large, outbred population (historical $N_e$ = 20k)
- No family structure (i.e. no pedigree simulations)

\vspace{0.3cm}

\begin{center}
\includegraphics[width=0.3\textwidth]{Images/herring.png}
\end{center}



##Scenario 2

- Large, outbred population (historical $N_e$ = 20k)
- Family structure

\vspace{0.3cm}

\begin{center}
\includegraphics[width=0.3\textwidth]{Images/greattit.png}
\end{center}




##Scenario 3

- Small, inbred population (historical $N_e$ = 500)
- Family structure

\vspace{0.3cm}

\begin{center}
\includegraphics[width=0.3\textwidth]{Images/seychelleswarb.png}
\end{center}




#Results


##Number of significant GWAS QTL


```{r gwas_qtl,fig.height = 7,fig.width = 7,fig.align = "center"}

g4_2 <- g4[,colnames(g4) %in% colnames(g1)]
g2_2 <- g2[,colnames(g2) %in% colnames(g1)]


temp <- rbind(g1,g2_2,g4_2)
temp$Scenario <- paste("Scenario",rep(c(1,2,3),c(nrow(g1),nrow(g2_2),nrow(g4_2))))

temp$Nids2 <- paste("N =",temp$Nids)
temp$Nids2 <- factor(temp$Nids2,levels = paste("N =",unique(temp$Nids)[order(unique(temp$Nids))]))

temp$Nsnps2 <- paste(temp$Nsnps,"SNPs")
temp$Nsnps2 <- factor(temp$Nsnps2,levels = paste(unique(temp$Nsnps)[order(unique(temp$Nsnps))],"SNPs"))

Fig2 <-  subset(temp, (SNP.Name %in% paste0("Q", c(1:10)))) %>%
  ddply(
  .(Nids2, Nsnps2, HistN, Full.Iteration.ID, Scenario),
  summarise,
  N_Sig_QTL = sum(Sig.Corrected == "yes")
  ) %>%
  ggplot(aes(x = Nids2, y = N_Sig_QTL, col = Nids2)) +
  geom_jitter(aes(shape = NA)) +
    geom_hline(yintercept = 10,lty = 2)+
  ylim(c(0,12))+
  facet_grid(Nsnps2 ~ Scenario) +
  theme_bw() +
  theme(legend.position = "none",
  axis.text.x = element_text(angle = 90)) +
  ylab("Number of GWAS hits") +
  xlab("")

Fig2

```


##Number of significant GWAS QTL


```{r gwas_qtl_2,fig.height = 7,fig.width = 7,fig.align = "center"}

g4_2 <- g4[,colnames(g4) %in% colnames(g1)]
g2_2 <- g2[,colnames(g2) %in% colnames(g1)]


temp <- rbind(g1,g2_2,g4_2)
temp$Scenario <- paste("Scenario",rep(c(1,2,3),c(nrow(g1),nrow(g2_2),nrow(g4_2))))

temp$Nids2 <- paste("N =",temp$Nids)
temp$Nids2 <- factor(temp$Nids2,levels = paste("N =",unique(temp$Nids)[order(unique(temp$Nids))]))

temp$Nsnps2 <- paste(temp$Nsnps,"SNPs")
temp$Nsnps2 <- factor(temp$Nsnps2,levels = paste(unique(temp$Nsnps)[order(unique(temp$Nsnps))],"SNPs"))

Fig2 <-  subset(temp, (SNP.Name %in% paste0("Q", c(1:10)))) %>%
  ddply(
  .(Nids2, Nsnps2, HistN, Full.Iteration.ID, Scenario),
  summarise,
  N_Sig_QTL = sum(Sig.Corrected == "yes")
  ) %>%
  ggplot(aes(x = Nids2, y = N_Sig_QTL, col = Nids2)) +
  geom_jitter() +
    geom_hline(yintercept = 10,lty = 2)+
  ylim(c(0,12))+
  facet_grid(Nsnps2 ~ Scenario) +
  theme_bw() +
  theme(legend.position = "none",
  axis.text.x = element_text(angle = 90)) +
  ylab("Number of GWAS hits") +
  xlab("")

Fig2

```


##Number of significant GWAS hits (non-QTL)


```{r gwas_nonqtl,fig.width = 7,fig.height = 7,fig.align = "center"}
g4_2 <- g4[,colnames(g4) %in% colnames(g1)]
g2_2 <- g2[,colnames(g2) %in% colnames(g1)]


temp <- rbind(g1,g2_2,g4_2)
temp$Scenario <- paste("Scenario",rep(c(1,2,3),c(nrow(g1),nrow(g2_2),nrow(g4_2))))

temp$Nids2 <- paste("N =",temp$Nids)
temp$Nids2 <- factor(temp$Nids2,levels = paste("N =",unique(temp$Nids)[order(unique(temp$Nids))]))

temp$Nsnps2 <- paste(temp$Nsnps,"SNPs")
temp$Nsnps2 <- factor(temp$Nsnps2,levels = paste(unique(temp$Nsnps)[order(unique(temp$Nsnps))],"SNPs"))

Fig2 <-  subset(temp, !(SNP.Name %in% paste0("Q", c(1:10)))) %>%
  ddply(
  .(Nids2, Nsnps2, HistN, Full.Iteration.ID, Scenario),
  summarise,
  N_Sig_QTL = sum(Sig.Corrected == "yes")
  ) %>%
  ggplot(aes(x = Nids2, y = N_Sig_QTL, col = Nids2)) +
  geom_jitter(aes(shape = NA)) +
    geom_hline(yintercept = 10,lty = 2)+
  facet_grid(Nsnps2 ~ Scenario) +
  theme_bw() +
  theme(legend.position = "none",
  axis.text.x = element_text(angle = 90)) +
  ylab("Number of GWAS hits") +
  xlab("")

Fig2

```

##Number of significant GWAS hits (non-QTL)


```{r gwas_nonqtl_2,fig.width = 7,fig.height = 7,fig.align = "center"}
g4_2 <- g4[,colnames(g4) %in% colnames(g1)]
g2_2 <- g2[,colnames(g2) %in% colnames(g1)]


temp <- rbind(g1,g2_2,g4_2)
temp$Scenario <- paste("Scenario",rep(c(1,2,3),c(nrow(g1),nrow(g2_2),nrow(g4_2))))

temp$Nids2 <- paste("N =",temp$Nids)
temp$Nids2 <- factor(temp$Nids2,levels = paste("N =",unique(temp$Nids)[order(unique(temp$Nids))]))

temp$Nsnps2 <- paste(temp$Nsnps,"SNPs")
temp$Nsnps2 <- factor(temp$Nsnps2,levels = paste(unique(temp$Nsnps)[order(unique(temp$Nsnps))],"SNPs"))

Fig2 <-  subset(temp, !(SNP.Name %in% paste0("Q", c(1:10)))) %>%
  ddply(
  .(Nids2, Nsnps2, HistN, Full.Iteration.ID, Scenario),
  summarise,
  N_Sig_QTL = sum(Sig.Corrected == "yes")
  ) %>%
  ggplot(aes(x = Nids2, y = N_Sig_QTL, col = Nids2)) +
  geom_jitter() +
    geom_hline(yintercept = 10,lty = 2)+
  facet_grid(Nsnps2 ~ Scenario) +
  theme_bw() +
  theme(legend.position = "none",
  axis.text.x = element_text(angle = 90)) +
  ylab("Number of GWAS hits") +
  xlab("")

Fig2

```

##Number of significant GWAS hits (non-QTL)


```{r gwas_nonqtl_3,fig.width = 6,fig.height = 7,fig.align = "center"}
g2_2 <- g2[,colnames(g2) %in% colnames(g1)]


temp <- rbind(g1,g2_2)
temp$Scenario <- paste("Scenario",rep(c(1,2),c(nrow(g1),nrow(g2_2))))

temp$Nids2 <- paste("N =",temp$Nids)
temp$Nids2 <- factor(temp$Nids2,levels = paste("N =",unique(temp$Nids)[order(unique(temp$Nids))]))

temp$Nsnps2 <- paste(temp$Nsnps,"SNPs")
temp$Nsnps2 <- factor(temp$Nsnps2,levels = paste(unique(temp$Nsnps)[order(unique(temp$Nsnps))],"SNPs"))

Fig2 <-  subset(temp, !(SNP.Name %in% paste0("Q", c(1:10)))) %>%
  ddply(
  .(Nids2, Nsnps2, HistN, Full.Iteration.ID, Scenario),
  summarise,
  N_Sig_QTL = sum(Sig.Corrected == "yes")
  ) %>%
  ggplot(aes(x = Nids2, y = N_Sig_QTL, col = Nids2)) +
  geom_jitter() +
    geom_hline(yintercept = 10,lty = 2)+
  facet_grid(Nsnps2 ~ Scenario) +
  theme_bw() +
  theme(legend.position = "none",
  axis.text.x = element_text(angle = 90)) +
  ylab("Number of GWAS hits") +
  xlab("")

Fig2

```

##Heritability


```{r h2,fig.height = 7,fig.width = 7,fig.align = "center"}

h4_2 <- h4[,colnames(h4) %in% colnames(h1)]
h2_2 <- h2[,colnames(h2) %in% colnames(h1)]


temp <- rbind(h1,h2_2,h4_2)
temp$Scenario <- paste("Scenario",rep(c(1,2,3),c(nrow(h1),nrow(h2_2),nrow(h4_2))))

temp$Nids2 <- paste("N =",temp$Nids)
temp$Nids2 <- factor(temp$Nids2,levels = paste("N =",unique(temp$Nids)[order(unique(temp$Nids))]))

temp$Nsnps2 <- paste(temp$Nsnps,"SNPs")
temp$Nsnps2 <- factor(temp$Nsnps2,levels = paste(unique(temp$Nsnps)[order(unique(temp$Nsnps))],"SNPs"))

Fig2 <-  
  ggplot(temp,aes(x = Nids2, y = H2, col = Nids2)) +
  geom_jitter(aes(shape = NA)) +
  geom_hline(yintercept = 0.4,lty = 2)+
  facet_grid(Nsnps2 ~ Scenario) +
  theme_bw() +
  theme(legend.position = "none",
  axis.text.x = element_text(angle = 90)) +
  ylab("Number of GWAS hits") +
  xlab("")

Fig2

```





##Heritability

```{r h2_2,fig.height = 7,fig.width = 7,fig.align = "center"}

h4_2 <- h4[,colnames(h4) %in% colnames(h1)]
h2_2 <- h2[,colnames(h2) %in% colnames(h1)]


temp <- rbind(h1,h2_2,h4_2)
temp$Scenario <- paste("Scenario",rep(c(1,2,3),c(nrow(h1),nrow(h2_2),nrow(h4_2))))

temp$Nids2 <- paste("N =",temp$Nids)
temp$Nids2 <- factor(temp$Nids2,levels = paste("N =",unique(temp$Nids)[order(unique(temp$Nids))]))

temp$Nsnps2 <- paste(temp$Nsnps,"SNPs")
temp$Nsnps2 <- factor(temp$Nsnps2,levels = paste(unique(temp$Nsnps)[order(unique(temp$Nsnps))],"SNPs"))

Fig2 <-  
  ggplot(temp,aes(x = Nids2, y = H2, col = Nids2)) +
  geom_jitter() +
  geom_hline(yintercept = 0.4,lty = 2)+
  facet_grid(Nsnps2 ~ Scenario) +
  theme_bw() +
  theme(legend.position = "none",
  axis.text.x = element_text(angle = 90)) +
  ylab("Number of GWAS hits") +
  xlab("")

Fig2

```


##Overall conclusions



#Thankyou!

#Thankyou!

#Thankyou!

#Thankyou!


##test

```{r}
plot(rnorm(1000))
```
